/**
 * Description
 *
 * Version 1.1
 *
 * This Js works implement angular app to filter qbox data 
 * and put the location name came from drupal to searched data.
 *
 * @package   octopus
 * @author    octopus
 * @copyright 2015-2016 octopus
 */


/**
 * Implements octopus Angular app for the project and redering the data from qbox
 */
var app = angular
    .module('octopus', ['ui.bootstrap', 'elasticjs.service', 'ngSanitize'])
    .constant('euiHost', 'http://6dc737d6002ed2be000.qbox.io'); // ACTION: change to cluster address

/**
 * Implements DropdownCtrl controller for rendering location name in dropdown menu
 */
app.controller('DropdownCtrl', function($scope, $http) {
	console.log("debug log");
    $scope.status = 'loading...';
    $scope.country = "Select Country";
    $scope.data = {
        "locations": {}
    };

    /**
     * Fetch location name from drupal
     */
	 var host = "http://www.ssdkolkata.net/octopus/drupal/?q=location-json";
	 console.log(host);
    $http.get(host)
        .then(function(res) {

            $scope.data.locations.term = res.data.nodes;
            $scope.status = "loaded " + $scope.data.locations.term.length + " term.";
            if (!$scope.$$phase) {

                $scope.$apply();
            }
        });

    //locationJson = $scope.data.locations;
	//console.log(locationJson);

});


/**
 * Implements AdminCtrl controller for rendering searched data from qbox using search query
 */

app.controller('AdminCtrl', function($scope, $http, ejsResource) {
    var locationJson = '';
	console.log("called here 13-5-15");
    $http.get('http://www.ssdkolkata.net/octopus/drupal/?q=location-json').then(function(mres) {
		$scope.data = {
			"mylocations": {}
		};
		$scope.data.mylocations.term = mres.data.nodes;		
		locationJson = $scope.data.mylocations;
		
		var ejs = ejsResource('http://6dc737d6002ed2be000.qbox.io');
		var oQuery = ejs.QueryStringQuery().defaultField('field_location');
		var client = ejs.Request()
			.indices('nodes');
		var myquery = oQuery.query($scope.queryTerm || '*');
		$scope.results = client
			.query(myquery)
			.doSearch();
		$scope.data = {
			"search_data": {}
		};	
	
		
		$scope.results.then(function(response) {
			$scope.data.search_data.term = response.hits.hits;
			$scope.status = "loaded " + $scope.data.search_data.term.length + " term.";
			if (!$scope.$$phase) {
				$scope.$apply();
			}
			if(locationJson == ""){
					console.log("it is blank");
				}
			angular.forEach(response.hits.hits, function(value, key) {
				var locid = parseInt(value._source.field_location);
				var body = value._source['body:value'];
				var created = value._source.created;
				var title = value._source.title;
				var locname = '';
				var breakit = 0;
				
				if(locationJson == ""){
					console.log("it is blank");
				}
				console.log("debug1");
				angular.forEach(locationJson, function(tvalue) {
				
					angular.forEach(tvalue, function(lvalue) {
						
						if (parseInt(lvalue.node.term_id) === locid) {
							locname = lvalue.node.name;
							breakit = 1;
						}
						if (breakit === 1) {
							return false;
						}

					});
					if (breakit === 1) {
						return false;
					}
				});
				/**
				 * Push location name in the searched data
				 */
				var try1 = $scope.data.search_data;
				$scope.data.search_data.term[key].locname = locname;

			});
		});
	});
	console.log("called here 1");
	

});